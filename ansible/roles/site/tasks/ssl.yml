# ssl.yml
#
# An Ansible playbook to create an SSL cirt using certbot
# uses instructions from https://certbot.eff.org/lets-encrypt/ubuntufocal-nginx
---
# Check if the SSL key files already exhist on the server
- name: Check if fullchain.pem file exhists
  stat: path=/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem
  register: fullchain_path
- name: Check if privkey.pem files exhists
  stat: path=/etc/letsencrypt/live/{{ domain_name }}/privkey.pem
  register: privkey_path

# Install certbot and the certbot nginx extension with apt
- name: Install certbot and the certbot nginx extension with apt
  apt:
    name:
    - certbot
    - python3-certbot-nginx
    state: present

# Deploy nginx config file with ssl included
- name: Deploy nginx config file to /etc/nginx/sites-available/mydomain.org
  template:
    src: templates/nginx_ssl.j2
    dest: "/etc/nginx/sites-available/{{ domain_name }}"
  when: not privkey_path.stat.exists and not fullchain_path.stat.exists
# Simlink sites-available to sites-enabled
- name: create symlink from site-available to sites-enabled
  file:
    src: "/etc/nginx/sites-available/{{ domain_name }}"
    dest: /etc/nginx/sites-enabled/default
    state: link
  # when: False
  when: True
  # when: not privkey_path.stat.exists and not fullchain_path.stat.exists

# Run Certbot
- name: Run certbot on the domain name using provided email address
  shell: certbot -d {{ domain_name }} --nginx -n --agree-tos -m {{ letsencrypt_account_email }}
  args:
    executable: /bin/bash
  # become: true
  register: certbot_stdout
  when: not privkey_path.stat.exists and not fullchain_path.stat.exists

- name: print out the certbot output
  debug:
    var: certbot_stdout.stdout_lines
  when: certbot_stdout

# Might have to change the permissions on the key files so nginx can read them
# Consider templating in a file for sites-enabled that includes the post certbot stuff, but also includes
# http --> https redirect.

# Restart nginx
- name: Restart the nginx systemd service
  systemd:
    state: restarted
    name: nginx
