---
- name: don't resize the root fs
  file:
    path: "{{ nfs_root }}/root/etc/init.d/resize2fs_once"
    state: absent

- name: don't manage a swap file
  file:
    path: "{{ nfs_root }}/etc/systemd/system/multi-user.target.wants/dphys-swapfile.service"
    state: absent

- name: avoid [FAILED] Failed to start Set console font and keymap.
  file:
    path: "{{ nfs_root }}/root/etc/systemd/system/multi-user.target.wants/console-setup.service"
    state: absent

- name: avoid Wi-Fi is currently blocked by rfkill.
  file:
    path: "{{ nfs_root }}/root/etc/profile.d/wifi-check.sh"
    state: absent

# FIXME
# - name: avoid [FAILED] Failed to start Hostname Service.
#  file:
#    path: "{{ nfs_root }}/"
#    state: absent
#

- name: set US keyboard
  copy:
    src: "files/etc/keyboard"
    dest: "{{ nfs_root }}/root/etc/default/"

- name: remove etc/hostname (dhclient will get hostname from server)
  file:
    path: "{{ nfs_root }}/root/etc/hostname"
    state: absent
  tags:
  - hostname

- name: set pistat_host in /etc/environment
  lineinfile:
    dest: "{{ nfs_root }}/root/etc/environment"
    state: present
    line: "pistat_host={{ domain_name}}"

# the rest of thiese tasks config the server to monitor client boot spew

- name: is server pi
  stat:
    path: /boot/firmware/config.txt
  register: is_pi
  tags:
  - ispi

- name: enable /dev/serial0
  ansible.builtin.lineinfile:
    dest: /boot/firmware/config.txt
    # regexp: (^|#\s*)Storage=
    line: "{{ item }}"
  with_items:
    - dtoverlay=disable-bt
  when: is_pi.stat.exists
  tags:
  - ispi

# https://bugs.debian.org/667616
# brltty greedily grabs serial ports, ftdi_sio loses connection
- name: apt remove brltty
  apt:
    name:
      - brltty
    state: absent

- name: install packages on server
  apt:
    name:
      - tio
      - ansible

- name: let tio connect to the tty and see pi boot messages
  ansible.builtin.user:
    name: "{{ user_name }}"
    groups: dialout
    append: true

# we don't need a getty snooping on the boot messages over the serial console
- name: disable (mask) getty systemd service
  systemd:
    enabled: false
    masked: true
    state: stopped
    name: serial-getty@ttyAMA0.service
  tags:
  - ispi

- name: Git checkout this repo for safer 2 hour onpi
  ansible.builtin.git:
    repo: 'https://github.com/CarlFK/pici.git'
    dest: "/home/{{ user_name }}/pici"
    depth: 1
    accept_hostkey: true
    force: true
      #  args:
      # creates: "/home/{{ user_name }}/pici"

 # ssh-keyscan -H remote_host.com >> /etc/ssh/ssh_known_hosts
